/**
    * @license
    * Copyright 2023 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@tensorflow/tfjs-core"),require("@tensorflow/tfjs-converter"),require("@mediapipe/selfie_segmentation")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs-core","@tensorflow/tfjs-converter","@mediapipe/selfie_segmentation"],e):e((t=t||self).bodySegmentation={},t.tf,t.tf,t.globalThis)}(this,(function(t,e,n,r){"use strict";var i=function(t,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},i(t,e)};function o(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var a=function(){return a=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},a.apply(this,arguments)};function s(t,e,n,r){return new(n||(n=Promise))((function(i,o){function a(t){try{u(r.next(t))}catch(t){o(t)}}function s(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}u((r=r.apply(t,e||[])).next())}))}function u(t,e){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function f(t){return t instanceof SVGAnimatedLength?t.baseVal.value:t}function d(t){return s(this,void 0,void 0,(function(){var n,r;return u(this,(function(i){switch(i.label){case 0:return n=document.createElement("canvas"),t instanceof e.Tensor?[4,e.browser.toPixels(t,n)]:[3,2];case 1:return i.sent(),[3,3];case 2:n.width=f(t.width),n.height=f(t.height),r=n.getContext("2d"),t instanceof ImageData?r.putImageData(t,0,0):r.drawImage(t,0,0),i.label=3;case 3:return[2,n]}}))}))}function l(t){return s(this,void 0,void 0,(function(){var n,r,i,o,a,s;return u(this,(function(u){switch(u.label){case 0:return t instanceof e.Tensor?(n=t.shape.slice(0,2),r=n[0],i=n[1],o=ImageData.bind,[4,e.browser.toPixels(t)]):[3,2];case 1:return[2,new(o.apply(ImageData,[void 0,u.sent(),i,r]))];case 2:return a=document.createElement("canvas"),s=a.getContext("2d"),a.width=f(t.width),a.height=f(t.height),s.drawImage(t,0,0),[2,s.getImageData(0,0,a.width,a.height)]}}))}))}function c(t){return s(this,void 0,void 0,(function(){var n,r;return u(this,(function(i){switch(i.label){case 0:return t instanceof SVGImageElement||t instanceof OffscreenCanvas?[4,d(t)]:[3,2];case 1:return r=i.sent(),[3,3];case 2:r=t,i.label=3;case 3:return n=r,[2,e.browser.fromPixels(n,4)]}}))}))}function h(t){if(t<0||t>=256)throw new Error("Mask value must be in range [0, 255] but got "+t);if(!Number.isInteger(t))throw new Error("Mask value must be an integer but got "+t)}var p=[[110,64,170],[143,61,178],[178,60,178],[210,62,167],[238,67,149],[255,78,125],[255,94,99],[255,115,75],[255,140,56],[239,167,47],[217,194,49],[194,219,64],[175,240,91],[135,245,87],[96,247,96],[64,243,115],[40,234,141],[28,219,169],[26,199,194],[33,176,213],[47,150,224],[65,125,224],[84,101,214],[99,81,195]];function m(t){var n=t.shape[2],r=e.argMax(t,2),i=e.reshape(r,[-1]);return e.oneHot(i,n)}function g(t,n){return e.tidy((function(){return e.cast(e.greater(t,e.scalar(n)),"int32")}))}function v(t,n){var r=n.shape,i=r[0],o=r[1],a=r[2];return e.tidy((function(){var r,s,u=m(n),f=e.expandDims(e.range(0,a,1,"int32"),1),d=e.cast(e.matMul(u,f),"int32"),l=e.reshape(d,[i,o]),c=e.add(l,e.scalar(1,"int32"));return e.sub((r=c,s=t,e.mul(r,s)),e.scalar(1,"int32"))}))}var w=function(){function t(t,n){this.model=t,this.outputStride=n;var r=this.model.inputs[0].shape;e.util.assert(-1===r[1]&&-1===r[2],(function(){return"Input shape ["+r[1]+", "+r[2]+"] must both be equal to or -1"}))}return t.prototype.predict=function(t){var n=this;return e.tidy((function(){var r=n.preprocessInput(e.cast(t,"float32")),i=e.expandDims(r,0),o=n.model.predict(i).map((function(t){return e.squeeze(t,[0])})),a=n.nameOutputResults(o);return{heatmapScores:e.sigmoid(a.heatmap),offsets:a.offsets,displacementFwd:a.displacementFwd,displacementBwd:a.displacementBwd,segmentation:a.segmentation,partHeatmaps:a.partHeatmaps,longOffsets:a.longOffsets,partOffsets:a.partOffsets}}))},t.prototype.dispose=function(){this.model.dispose()},t}(),y=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return o(n,t),n.prototype.preprocessInput=function(t){return e.tidy((function(){return e.sub(e.div(t,127.5),1)}))},n.prototype.nameOutputResults=function(t){return{offsets:t[0],segmentation:t[1],partHeatmaps:t[2],longOffsets:t[3],heatmap:t[4],displacementFwd:t[5],displacementBwd:t[6],partOffsets:t[7]}},n}(w),b=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"],S=b.length,x=b.reduce((function(t,e,n){return t[e]=n,t}),{});[["leftHip","leftShoulder"],["leftElbow","leftShoulder"],["leftElbow","leftWrist"],["leftHip","leftKnee"],["leftKnee","leftAnkle"],["rightHip","rightShoulder"],["rightElbow","rightShoulder"],["rightElbow","rightWrist"],["rightHip","rightKnee"],["rightKnee","rightAnkle"],["leftShoulder","rightShoulder"],["leftHip","rightHip"]].map((function(t){var e=t[0],n=t[1];return[x[e],x[n]]}));function M(t,e,n){var r=t[0],i=t[1],o=e[0],a=e[1],s=n.top,u=n.bottom;return[a/(n.left+n.right+i),o/(s+u+r)]}function k(t,e,n,r){return{y:r.get(t,e,n),x:r.get(t,e,n+S)}}function T(t,e,n){var r=k(t.heatmapY,t.heatmapX,t.id,n),i=r.y,o=r.x;return{x:t.heatmapX*e+o,y:t.heatmapY*e+i}}function E(t,e,n){return t<e?e:t>n?n:t}function P(t,e){return{x:t.x+e.x,y:t.y+e.y}}function I(t,e,n){void 0===n&&(n=.3);for(var r=0,i=0,o=0;o<t.length;o++)e.keypoints[o].score>n&&(i+=1,r+=Math.pow(t[o].x-e.keypoints[o].position.x,2)+Math.pow(t[o].y-e.keypoints[o].position.y,2));return 0===i?r=1/0:r/=i,r}function O(t,e,n,r,i,o,a){for(var s=a[0],u=a[1],f=n(t),d=f.y*r+f.x,l=i[S*(2*d)+e],c=i[S*(2*d+1)+e],h=t.y+l,p=t.x+c,m=0;m<o;m++){h=Math.min(h,s-1);var g=n({x:p=Math.min(p,u-1),y:h}),v=g.y*r+g.x;h+=l=i[S*(2*v)+e],p+=c=i[S*(2*v+1)+e]}return{x:p,y:h}}function _(t,e,n,r,i,o,a,s,u,f){for(var d=i[0],l=i[1],c=o[0],h=o[1],p=s[0],m=s[1],g=[],v=function(t){return function(t,e,n,r){var i=e[0],o=e[1],a=n[0],s=n[1],u=Math.round(((i+t.y+1)*s-1)/r);return{x:Math.round(((o+t.x+1)*a-1)/r),y:u}}(t,[d,l],[c,h],u)},w=0;w<r;w++){var y=O(t,w,v,a,e,f,[p,m]);g.push(y)}for(var b=-1,S=1/0,x=0;x<n.length;x++){var M=I(g,n[x]);M<S&&(b=x,S=M)}return b}function H(t,e){var n=t[0],r=t[1];return[Math.round((r-1)/e+1),Math.round((n-1)/e+1)]}function A(t,n,r,i,o,a,s,u,f,d,l){for(var c=s[0],h=s[1],p=t.shape,m=p[0],g=p[1],v=n.shape.slice(0,2),w=v[0],y=v[1],b=e.reshape(n,[w,y,2,S]),x=new Float32Array(l*S*3).fill(0),k=0;k<r.length;k++)for(var T=k*S*3,E=r[k],P=0;P<S;P++){var I=E.keypoints[P],O=T+3*P;x[O]=I.score,x[O+1]=I.position.y,x[O+2]=I.position.x}var _=M([i,o],[c,h],u),H=_[0],A=_[1],R=e.tensor(x,[l,S,3]),D=u.top,F=u.left,C={variableNames:["segmentation","longOffsets","poses"],outputShape:[m,g],userCode:"\n    int convertToPositionInOutput(int pos, int pad, float scale, int stride) {\n      return round(((float(pos + pad) + 1.0) * scale - 1.0) / float(stride));\n    }\n\n    float convertToPositionInOutputFloat(\n        int pos, int pad, float scale, int stride) {\n      return ((float(pos + pad) + 1.0) * scale - 1.0) / float(stride);\n    }\n\n    float dist(float x1, float y1, float x2, float y2) {\n      return pow(x1 - x2, 2.0) + pow(y1 - y2, 2.0);\n    }\n\n    float sampleLongOffsets(float h, float w, int d, int k) {\n      float fh = fract(h);\n      float fw = fract(w);\n      int clH = int(ceil(h));\n      int clW = int(ceil(w));\n      int flH = int(floor(h));\n      int flW = int(floor(w));\n      float o11 = getLongOffsets(flH, flW, d, k);\n      float o12 = getLongOffsets(flH, clW, d, k);\n      float o21 = getLongOffsets(clH, flW, d, k);\n      float o22 = getLongOffsets(clH, clW, d, k);\n      float o1 = mix(o11, o12, fw);\n      float o2 = mix(o21, o22, fw);\n      return mix(o1, o2, fh);\n    }\n\n    int findNearestPose(int h, int w) {\n      float prob = getSegmentation(h, w);\n      if (prob < 1.0) {\n        return -1;\n      }\n\n      // Done(Tyler): convert from output space h/w to strided space.\n      float stridedH = convertToPositionInOutputFloat(\n        h, "+D+", "+A+", "+a+");\n      float stridedW = convertToPositionInOutputFloat(\n        w, "+F+", "+H+", "+a+");\n\n      float minDist = 1000000.0;\n      int iMin = -1;\n      for (int i = 0; i < "+l+"; i++) {\n        float curDistSum = 0.0;\n        int numKpt = 0;\n        for (int k = 0; k < "+S+"; k++) {\n          float dy = sampleLongOffsets(stridedH, stridedW, 0, k);\n          float dx = sampleLongOffsets(stridedH, stridedW, 1, k);\n\n          float y = float(h) + dy;\n          float x = float(w) + dx;\n\n          for (int s = 0; s < "+f+"; s++) {\n            int yRounded = round(min(y, float("+(i-1)+")));\n            int xRounded = round(min(x, float("+(o-1)+")));\n\n            float yStrided = convertToPositionInOutputFloat(\n              yRounded, "+D+", "+A+", "+a+");\n            float xStrided = convertToPositionInOutputFloat(\n              xRounded, "+F+", "+H+", "+a+");\n\n            float dy = sampleLongOffsets(yStrided, xStrided, 0, k);\n            float dx = sampleLongOffsets(yStrided, xStrided, 1, k);\n\n            y = y + dy;\n            x = x + dx;\n          }\n\n          float poseScore = getPoses(i, k, 0);\n          float poseY = getPoses(i, k, 1);\n          float poseX = getPoses(i, k, 2);\n          if (poseScore > "+d+") {\n            numKpt = numKpt + 1;\n            curDistSum = curDistSum + dist(x, y, poseX, poseY);\n          }\n        }\n        if (numKpt > 0 && curDistSum / float(numKpt) < minDist) {\n          minDist = curDistSum / float(numKpt);\n          iMin = i;\n        }\n      }\n      return iMin;\n    }\n\n    void main() {\n        ivec2 coords = getOutputCoords();\n        int nearestPose = findNearestPose(coords[0], coords[1]);\n        setOutput(float(nearestPose));\n      }\n  "};return e.backend().compileAndRun(C,[t,b,R])}function R(){return"webgl"===e.getBackend()}function D(t,n,r,i,o,a,f,d,l,c,h,p){var m=f[0],g=f[1];return void 0===l&&(l=.2),void 0===c&&(c=8),void 0===h&&(h=.3),void 0===p&&(p=10),s(this,void 0,void 0,(function(){var s,f,v,w,y;return u(this,(function(u){switch(u.label){case 0:return s=r.filter((function(t){return t.score>=l})),R()?(v=e.tidy((function(){var r=A(t,n,s,i,o,a,[m,g],d,c,h,p),u=e.engine().makeTensorFromDataId(r.dataId,r.shape,r.dtype);return s.map((function(t,n){return function(t,n){return e.tidy((function(){return e.cast(e.equal(t,e.scalar(n)),"int32")}))}(u,n)}))})),[4,Promise.all(v.map((function(t){return t.data()})))]):[3,2];case 1:return f=u.sent(),v.forEach((function(t){return t.dispose()})),[3,5];case 2:return[4,t.data()];case 3:return w=u.sent(),[4,n.data()];case 4:y=u.sent(),f=function(t,e,n,r,i,o,a,s,u,f){var d=a[0],l=a[1];void 0===f&&(f=5);for(var c=n.map((function(t){return new Uint8Array(r*i).fill(0)})),h=s.top,p=s.left,m=M([r,i],[d,l],s),g=m[0],v=m[1],w=H([d,l],o)[0],y=0;y<r;y+=1)for(var b=0;b<i;b+=1){var S=y*i+b;if(1===t[S]){var x=_({x:b,y:y},e,n,f,[h,p],[g,v],w,[r,i],o,u);x>=0&&(c[x][S]=1)}}return c}(w,y,s,i,o,a,[m,g],d,c),u.label=5;case 5:return[2,f.map((function(t,e){return{data:t,pose:s[e],width:o,height:i}}))]}}))}))}function F(t,n,r,i,o,a,f,d,l,c,h,p,m){var g=d[0],v=d[1];return void 0===c&&(c=.2),void 0===h&&(h=8),void 0===p&&(p=.3),void 0===m&&(m=10),s(this,void 0,void 0,(function(){var s,d,w,y,b,S;return u(this,(function(u){switch(u.label){case 0:return s=i.filter((function(t){return t.score>=c})),R()?(w=e.tidy((function(){var i=A(t,n,s,o,a,f,[g,v],l,h,p,m),u=e.engine().makeTensorFromDataId(i.dataId,i.shape,i.dtype);return s.map((function(t,n){return function(t,n,r){return e.tidy((function(){return e.sub(e.mul(e.cast(e.equal(t,e.scalar(r)),"int32"),e.add(n,1)),1)}))}(u,r,n)}))})),[4,Promise.all(w.map((function(t){return t.data()})))]):[3,2];case 1:return d=u.sent(),w.forEach((function(t){return t.dispose()})),[3,6];case 2:return[4,t.data()];case 3:return y=u.sent(),[4,n.data()];case 4:return b=u.sent(),[4,r.data()];case 5:S=u.sent(),d=function(t,e,n,r,i,o,a,s,u,f,d){var l=s[0],c=s[1];void 0===d&&(d=5);for(var h=r.map((function(t){return new Int32Array(i*o).fill(-1)})),p=u.top,m=u.left,g=M([i,o],[l,c],u),v=g[0],w=g[1],y=H([l,c],a)[0],b=0;b<i;b+=1)for(var S=0;S<o;S+=1){var x=b*o+S;if(1===t[x]){var k=_({x:S,y:b},e,r,d,[p,m],[v,w],y,[i,o],a,f);k>=0&&(h[k][x]=n[x])}}return h}(y,b,S,s,o,a,f,[g,v],l,h),u.label=6;case 6:return[2,d.map((function(t,e){return{pose:s[e],data:t,height:o,width:a}}))]}}))}))}function C(t){return Math.floor(t/2)}var B=function(){function t(t,e){this.priorityQueue=new Array(t),this.numberOfElements=-1,this.getElementValue=e}return t.prototype.enqueue=function(t){this.priorityQueue[++this.numberOfElements]=t,this.swim(this.numberOfElements)},t.prototype.dequeue=function(){var t=this.priorityQueue[0];return this.exchange(0,this.numberOfElements--),this.sink(0),this.priorityQueue[this.numberOfElements+1]=null,t},t.prototype.empty=function(){return-1===this.numberOfElements},t.prototype.size=function(){return this.numberOfElements+1},t.prototype.all=function(){return this.priorityQueue.slice(0,this.numberOfElements+1)},t.prototype.max=function(){return this.priorityQueue[0]},t.prototype.swim=function(t){for(;t>0&&this.less(C(t),t);)this.exchange(t,C(t)),t=C(t)},t.prototype.sink=function(t){for(;2*t<=this.numberOfElements;){var e=2*t;if(e<this.numberOfElements&&this.less(e,e+1)&&e++,!this.less(t,e))break;this.exchange(t,e),t=e}},t.prototype.getValueAt=function(t){return this.getElementValue(this.priorityQueue[t])},t.prototype.less=function(t,e){return this.getValueAt(t)<this.getValueAt(e)},t.prototype.exchange=function(t,e){var n=this.priorityQueue[t];this.priorityQueue[t]=this.priorityQueue[e],this.priorityQueue[e]=n},t}();function z(t,e,n,r,i,o){for(var a=o.shape,s=a[0],u=a[1],f=!0,d=Math.max(n-i,0),l=Math.min(n+i+1,s),c=d;c<l;++c){for(var h=Math.max(r-i,0),p=Math.min(r+i+1,u),m=h;m<p;++m)if(o.get(c,m,t)>e){f=!1;break}if(!f)break}return f}var L=[["nose","leftEye"],["leftEye","leftEar"],["nose","rightEye"],["rightEye","rightEar"],["nose","leftShoulder"],["leftShoulder","leftElbow"],["leftElbow","leftWrist"],["leftShoulder","leftHip"],["leftHip","leftKnee"],["leftKnee","leftAnkle"],["nose","rightShoulder"],["rightShoulder","rightElbow"],["rightElbow","rightWrist"],["rightShoulder","rightHip"],["rightHip","rightKnee"],["rightKnee","rightAnkle"]].map((function(t){var e=t[0],n=t[1];return[x[e],x[n]]})),q=L.map((function(t){return t[1]})),W=L.map((function(t){return t[0]}));function j(t,e,n,r){return{y:E(Math.round(t.y/e),0,n-1),x:E(Math.round(t.x/e),0,r-1)}}function V(t,e,n,r,i,o,a,s){void 0===s&&(s=2);for(var u=r.shape,f=u[0],d=u[1],l=function(t,e,n){var r=n.shape[2]/2;return{y:n.get(e.y,e.x,t),x:n.get(e.y,e.x,r+t)}}(t,j(e.position,o,f,d),a),c=P(e.position,l),h=0;h<s;h++){var p=j(c,o,f,d),m=k(p.y,p.x,n,i);c=P({x:p.x*o,y:p.y*o},{x:m.x,y:m.y})}var g=j(c,o,f,d),v=r.get(g.y,g.x,n);return{position:c,part:b[n],score:v}}function K(t,e,n,r,i,o){var a=e.shape[2],s=q.length,u=new Array(a),f=t.part,d=t.score,l=T(f,r,n);u[f.id]={score:d,part:b[f.id],position:l};for(var c=s-1;c>=0;--c){var h=q[c],p=W[c];u[h]&&!u[p]&&(u[p]=V(c,u[h],p,e,n,r,o))}for(c=0;c<s;++c){h=W[c],p=q[c];u[h]&&!u[p]&&(u[p]=V(c,u[h],p,e,n,r,i))}return u}function U(t,e,n,r){var i=n.x,o=n.y;return t.some((function(t){var n,a,s,u,f,d,l=t.keypoints[r].position;return n=o,a=i,s=l.y,u=l.x,(f=s-n)*f+(d=u-a)*d<=e}))}function N(t,e,n){var r=n.reduce((function(n,r,i){var o=r.position,a=r.score;return U(t,e,o,i)||(n+=a),n}),0);return r/n.length}function Q(t,e,n,r,i,o,a,s){void 0===a&&(a=.5),void 0===s&&(s=20);for(var u=[],f=function(t,e,n){for(var r=n.shape,i=r[0],o=r[1],a=r[2],s=new B(i*o*a,(function(t){return t.score})),u=0;u<i;++u)for(var f=0;f<o;++f)for(var d=0;d<a;++d){var l=n.get(u,f,d);l<t||z(d,l,u,f,e,n)&&s.enqueue({score:l,part:{heatmapY:u,heatmapX:f,id:d}})}return s}(a,1,t),d=s*s;u.length<o&&!f.empty();){var l=f.dequeue();if(!U(u,d,T(l.part,i,e),l.part.id)){var c=K(l,t,e,i,n,r),h=N(u,d,c);u.push({keypoints:c,score:h})}}return u}var G,X=[-123.15,-115.9,-103.06],Y=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return o(n,t),n.prototype.preprocessInput=function(t){return e.add(t,X)},n.prototype.nameOutputResults=function(t){var e=t[0],n=t[1],r=t[2],i=t[3],o=t[4],a=t[5];return{offsets:o,segmentation:t[6],partHeatmaps:a,longOffsets:i,heatmap:r,displacementFwd:n,displacementBwd:e,partOffsets:t[7]}},n}(w),$="https://storage.googleapis.com/tfjs-models/savedmodel/bodypix/resnet50/",J="https://storage.googleapis.com/tfjs-models/savedmodel/bodypix/mobilenet/";function Z(t){if("undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas||"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement)return function(t){if("offsetHeight"in t&&0!==t.offsetHeight&&"offsetWidth"in t&&0!==t.offsetWidth)return[t.offsetHeight,t.offsetWidth];if(null!=t.height&&null!=t.width)return[t.height,t.width];throw new Error("HTMLImageElement must have height and width attributes set.")}(t);if("undefined"!=typeof ImageData&&t instanceof ImageData)return[t.height,t.width];if("undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement)return function(t){return t.hasAttribute("height")&&t.hasAttribute("width")?[t.height,t.width]:[t.videoHeight,t.videoWidth]}(t);if(t instanceof e.Tensor)return[t.shape[0],t.shape[1]];throw new Error("error: Unknown input type: "+t+".")}function tt(t,e){return function(t,e){return(t-1)%e==0}(t,e)?t:Math.floor(t/e)*e+1}var et={low:"low",medium:"medium",high:"high",full:"full"},nt=((G={})[et.low]=.25,G[et.medium]=.5,G[et.high]=.75,G[et.full]=1,G);function rt(t,n,r){var i=r[0],o=r[1],a=function(t){if("string"==typeof t){var n=nt[t];return e.util.assert("number"==typeof n,(function(){return"string value of inputResolution must be one of "+Object.values(et).join(",")+" but was "+t+"."})),n}return e.util.assert("number"==typeof t&&t<=2&&t>=.1,(function(){return"inputResolution must be a string or number between 0.1 and 2, but was "+t})),t}(t);return[tt(i*a,n),tt(o*a,n)]}function it(t,n,r,i,o){var a=n[0],s=n[1],u=r[0],f=r[1],d=i[0],l=d[0],c=d[1],h=i[1],p=h[0],m=h[1];return void 0===o&&(o=!1),e.tidy((function(){var n=e.image.resizeBilinear(t,[u,f],!0);return o&&(n=e.sigmoid(n)),function(t,n,r){var i=n[0],o=n[1],a=r[0],s=a[0],u=a[1],f=r[1],d=f[0],l=f[1];return e.tidy((function(){var n=e.expandDims(t);return e.squeeze(e.image.cropAndResize(n,[[s/(i+s+u-1),d/(o+d+l-1),(s+i-1)/(i+s+u-1),(d+o-1)/(o+d+l-1)]],[0],[i,o]),[0])}))}(n,[a,s],[[l,c],[p,m]])}))}function ot(t,n){var r=n[0],i=n[1],o=Z(t),a=o[0],s=o[1],u=i/r,f=[0,0,0,0],d=f[0],l=f[1],c=f[2],h=f[3];s/a<u?(d=0,l=0,c=Math.round(.5*(u*a-s)),h=Math.round(.5*(u*a-s))):(d=Math.round(.5*(1/u*s-a)),l=Math.round(.5*(1/u*s-a)),c=0,h=0);var p=e.tidy((function(){var n=function(t){return t instanceof e.Tensor?t:e.browser.fromPixels(t)}(t);return n=e.pad3d(n,[[d,l],[c,h],[0,0]]),e.image.resizeBilinear(n,[r,i])}));return{resized:p,padding:{top:d,left:c,right:h,bottom:l}}}function at(t){return s(this,void 0,void 0,(function(){return u(this,(function(e){return[2,Promise.all(t.map((function(t){return t.buffer()})))]}))}))}function st(t,e,n,r,i){var o=e[0],a=e[1],s=n[0],u=n[1],f=function(t,e,n,r,i){return void 0===r&&(r=0),void 0===i&&(i=0),1===n&&1===e&&0===r&&0===i?t:t.map((function(t){return function(t,e,n,r,i){return void 0===r&&(r=0),void 0===i&&(i=0),{score:t.score,keypoints:t.keypoints.map((function(t){var o=t.score,a=t.part,s=t.position;return{score:o,part:a,position:{x:s.x*n+i,y:s.y*e+r}}}))}}(t,e,n,r,i)}))}(t,(o+r.top+r.bottom)/s,(a+r.left+r.right)/u,-r.top,-r.left);return i?function(t,e){return e<=0?t:t.map((function(t){return function(t,e){return{score:t.score,keypoints:t.keypoints.map((function(t){var n=t.score,r=t.part,i=t.position;return{score:n,part:r,position:{x:e-1-i.x,y:i.y}}}))}}(t,e)}))}(f,a):f}var ut=!0,ft=!1,dt={architecture:"MobileNetV1",outputStride:16,quantBytes:4,multiplier:.75},lt=["MobileNetV1","ResNet50"],ct={MobileNetV1:[8,16,32],ResNet50:[32,16]},ht={MobileNetV1:[.5,.75,1],ResNet50:[1]},pt=[1,2,4];var mt={flipHorizontal:!1,internalResolution:"medium",segmentationThreshold:.7,maxDetections:10,scoreThreshold:.4,nmsRadius:20},gt={flipHorizontal:!1,internalResolution:"medium",segmentationThreshold:.7,maxDetections:10,scoreThreshold:.4,nmsRadius:20,minKeypointScore:.3,refineSteps:10};function vt(t){var e=t.segmentationThreshold,n=t.maxDetections,r=t.scoreThreshold,i=t.nmsRadius;if(e<0||e>1)throw new Error("segmentationThreshold "+e+". Should be in range [0.0, 1.0]");if(n<=0)throw new Error("Invalid maxDetections "+n+". Should be > 0");if(r<0||r>1)throw new Error("Invalid scoreThreshold "+r+". Should be in range [0.0, 1.0]");if(i<=0)throw new Error("Invalid nmsRadius "+i+".")}function wt(t){var e=t.segmentationThreshold,n=t.maxDetections,r=t.scoreThreshold,i=t.nmsRadius,o=t.minKeypointScore,a=t.refineSteps;if(e<0||e>1)throw new Error("segmentationThreshold "+e+". Should be in range [0.0, 1.0]");if(n<=0)throw new Error("Invalid maxDetections "+n+". Should be > 0");if(r<0||r>1)throw new Error("Invalid scoreThreshold "+r+". Should be in range [0.0, 1.0]");if(i<=0)throw new Error("Invalid nmsRadius "+i+".");if(o<0||o>1)throw new Error("Invalid minKeypointScore "+o+".Should be in range [0.0, 1.0]");if(a<=0||a>20)throw new Error("Invalid refineSteps "+a+".Should be in range [1, 20]")}var yt=function(){function t(t){this.baseModel=t}return t.prototype.predictForPersonSegmentation=function(t){var e=this.baseModel.predict(t);return{segmentLogits:e.segmentation,heatmapScores:e.heatmapScores,offsets:e.offsets,displacementFwd:e.displacementFwd,displacementBwd:e.displacementBwd}},t.prototype.predictForPersonSegmentationAndPart=function(t){var e=this.baseModel.predict(t);return{segmentLogits:e.segmentation,partHeatmapLogits:e.partHeatmaps,heatmapScores:e.heatmapScores,offsets:e.offsets,displacementFwd:e.displacementFwd,displacementBwd:e.displacementBwd}},t.prototype.predictForMultiPersonInstanceSegmentationAndPart=function(t){var e=this.baseModel.predict(t);return{segmentLogits:e.segmentation,longOffsets:e.longOffsets,heatmapScores:e.heatmapScores,offsets:e.offsets,displacementFwd:e.displacementFwd,displacementBwd:e.displacementBwd,partHeatmaps:e.partHeatmaps}},t.prototype.segmentPersonActivation=function(t,n,r){var i=this;void 0===r&&(r=.5);var o=Z(t),a=o[0],s=o[1],u=rt(n,this.baseModel.outputStride,[a,s]),f=ot(t,u),d=f.resized,l=f.padding,c=e.tidy((function(){var t=i.predictForPersonSegmentation(d),n=t.segmentLogits,o=t.heatmapScores,u=t.offsets,f=t.displacementFwd,c=t.displacementBwd,h=d.shape,p=h[0],m=h[1],v=it(n,[a,s],[p,m],[[l.top,l.bottom],[l.left,l.right]],ut);return{segmentation:g(e.squeeze(v),r),heatmapScores:o,offsets:u,displacementFwd:f,displacementBwd:c}})),h=c.segmentation,p=c.heatmapScores,m=c.offsets,v=c.displacementFwd,w=c.displacementBwd;return d.dispose(),{segmentation:h,heatmapScores:p,offsets:m,displacementFwd:v,displacementBwd:w,padding:l,internalResolutionHeightAndWidth:u}},t.prototype.segmentPerson=function(t,e){return void 0===e&&(e=mt),s(this,void 0,void 0,(function(){var n,r,i,o,s,f,d,l,c,h,p,m,g,v,w,y,b,S;return u(this,(function(u){switch(u.label){case 0:return vt(e=a(a({},mt),e)),n=this.segmentPersonActivation(t,e.internalResolution,e.segmentationThreshold),r=n.segmentation,i=n.heatmapScores,o=n.offsets,s=n.displacementFwd,f=n.displacementBwd,d=n.padding,l=n.internalResolutionHeightAndWidth,c=r.shape,h=c[0],p=c[1],[4,r.data()];case 1:return m=u.sent(),r.dispose(),[4,at([i,o,s,f])];case 2:return g=u.sent(),v=g[0],w=g[1],y=g[2],b=g[3],S=st(S=Q(v,w,y,b,this.baseModel.outputStride,e.maxDetections,e.scoreThreshold,e.nmsRadius),[h,p],l,d,ft),i.dispose(),o.dispose(),s.dispose(),f.dispose(),[2,{height:h,width:p,data:m,allPoses:S}]}}))}))},t.prototype.segmentMultiPerson=function(t,n){return void 0===n&&(n=gt),s(this,void 0,void 0,(function(){var r,i,o,s,f,d,l,c,h,p,m,v,w,y,b,S,x,M,k,T,E,P=this;return u(this,(function(u){switch(u.label){case 0:return wt(n=a(a({},gt),n)),r=Z(t),i=r[0],o=r[1],s=rt(n.internalResolution,this.baseModel.outputStride,[i,o]),f=ot(t,s),d=f.resized,l=f.padding,c=e.tidy((function(){var t,r=P.predictForMultiPersonInstanceSegmentationAndPart(d),a=r.segmentLogits,u=r.longOffsets,f=r.heatmapScores,c=r.offsets,h=r.displacementFwd,p=r.displacementBwd,m=it(a,[i,o],s,[[l.top,l.bottom],[l.left,l.right]],ut);return t=u,{segmentation:g(e.squeeze(m),n.segmentationThreshold),longOffsets:t,heatmapScoresRaw:f,offsetsRaw:c,displacementFwdRaw:h,displacementBwdRaw:p}})),h=c.segmentation,p=c.longOffsets,m=c.heatmapScoresRaw,v=c.offsetsRaw,w=c.displacementFwdRaw,y=c.displacementBwdRaw,[4,at([m,v,w,y])];case 1:return b=u.sent(),S=b[0],x=b[1],M=b[2],k=b[3],T=st(T=Q(S,x,M,k,this.baseModel.outputStride,n.maxDetections,n.scoreThreshold,n.nmsRadius),[i,o],s,l,ft),[4,D(h,p,T,i,o,this.baseModel.outputStride,s,l,n.scoreThreshold,n.refineSteps,n.minKeypointScore,n.maxDetections)];case 2:return E=u.sent(),d.dispose(),h.dispose(),p.dispose(),m.dispose(),v.dispose(),w.dispose(),y.dispose(),[2,E]}}))}))},t.prototype.segmentPersonPartsActivation=function(t,n,r){var i=this;void 0===r&&(r=.5);var o=Z(t),a=o[0],s=o[1],u=rt(n,this.baseModel.outputStride,[a,s]),f=ot(t,u),d=f.resized,l=f.padding,c=e.tidy((function(){var t=i.predictForPersonSegmentationAndPart(d),n=t.segmentLogits,o=t.partHeatmapLogits,u=t.heatmapScores,f=t.offsets,c=t.displacementFwd,h=t.displacementBwd,p=d.shape,m=p[0],w=p[1],y=it(n,[a,s],[m,w],[[l.top,l.bottom],[l.left,l.right]],ut),b=it(o,[a,s],[m,w],[[l.top,l.bottom],[l.left,l.right]],ut);return{partSegmentation:v(g(e.squeeze(y),r),b),heatmapScores:u,offsets:f,displacementFwd:c,displacementBwd:h}})),h=c.partSegmentation,p=c.heatmapScores,m=c.offsets,w=c.displacementFwd,y=c.displacementBwd;return d.dispose(),{partSegmentation:h,heatmapScores:p,offsets:m,displacementFwd:w,displacementBwd:y,padding:l,internalResolutionHeightAndWidth:u}},t.prototype.segmentPersonParts=function(t,e){return void 0===e&&(e=mt),s(this,void 0,void 0,(function(){var n,r,i,o,s,f,d,l,c,h,p,m,g,v,w,y,b,S;return u(this,(function(u){switch(u.label){case 0:return vt(e=a(a({},mt),e)),n=this.segmentPersonPartsActivation(t,e.internalResolution,e.segmentationThreshold),r=n.partSegmentation,i=n.heatmapScores,o=n.offsets,s=n.displacementFwd,f=n.displacementBwd,d=n.padding,l=n.internalResolutionHeightAndWidth,c=r.shape,h=c[0],p=c[1],[4,r.data()];case 1:return m=u.sent(),r.dispose(),[4,at([i,o,s,f])];case 2:return g=u.sent(),v=g[0],w=g[1],y=g[2],b=g[3],S=st(S=Q(v,w,y,b,this.baseModel.outputStride,e.maxDetections,e.scoreThreshold,e.nmsRadius),[h,p],l,d,ft),i.dispose(),o.dispose(),s.dispose(),f.dispose(),[2,{height:h,width:p,data:m,allPoses:S}]}}))}))},t.prototype.segmentMultiPersonParts=function(t,n){return void 0===n&&(n=gt),s(this,void 0,void 0,(function(){var r,i,o,s,f,d,l,c,h,p,v,w,y,b,S,x,M,k,T,E,P,I,O=this;return u(this,(function(u){switch(u.label){case 0:return wt(n=a(a({},gt),n)),r=Z(t),i=r[0],o=r[1],s=rt(n.internalResolution,this.baseModel.outputStride,[i,o]),f=ot(t,s),d=f.resized,l=f.padding,c=e.tidy((function(){var t=O.predictForMultiPersonInstanceSegmentationAndPart(d),r=t.segmentLogits,a=t.longOffsets,u=t.heatmapScores,f=t.offsets,c=t.displacementFwd,h=t.displacementBwd,p=t.partHeatmaps,v=it(r,[i,o],s,[[l.top,l.bottom],[l.left,l.right]],ut),w=it(p,[i,o],s,[[l.top,l.bottom],[l.left,l.right]],ut),y=a,b=g(e.squeeze(v),n.segmentationThreshold),S=function(t){var n=t.shape,r=n[0],i=n[1],o=n[2];return e.tidy((function(){var n=m(t),a=e.expandDims(e.range(0,o,1,"int32"),1),s=e.cast(e.matMul(n,a),"int32");return e.reshape(s,[r,i])}))}(w);return{segmentation:b,longOffsets:y,heatmapScoresRaw:u,offsetsRaw:f,displacementFwdRaw:c,displacementBwdRaw:h,partSegmentation:S}})),h=c.segmentation,p=c.longOffsets,v=c.heatmapScoresRaw,w=c.offsetsRaw,y=c.displacementFwdRaw,b=c.displacementBwdRaw,S=c.partSegmentation,[4,at([v,w,y,b])];case 1:return x=u.sent(),M=x[0],k=x[1],T=x[2],E=x[3],P=st(P=Q(M,k,T,E,this.baseModel.outputStride,n.maxDetections,n.scoreThreshold,n.nmsRadius),[i,o],s,l,ft),[4,F(h,p,S,P,i,o,this.baseModel.outputStride,s,l,n.scoreThreshold,n.refineSteps,n.minKeypointScore,n.maxDetections)];case 2:return I=u.sent(),d.dispose(),h.dispose(),p.dispose(),v.dispose(),w.dispose(),y.dispose(),b.dispose(),S.dispose(),[2,I]}}))}))},t.prototype.dispose=function(){this.baseModel.dispose()},t}();function bt(t){return s(this,void 0,void 0,(function(){var r,i,o,a,s,f;return u(this,(function(u){switch(u.label){case 0:if(r=t.outputStride,i=t.quantBytes,o=t.multiplier,null==e)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this\n        model.");return a=function(t,e,n){var r={1:"100",.75:"075",.5:"050"},i="model-stride"+t+".json";return 4===n?J+"float/"+r[e]+"/"+i:J+"quant"+n+"/"+r[e]+"/"+i}(r,o,i),[4,n.loadGraphModel(t.modelUrl||a)];case 1:return s=u.sent(),f=new y(s,r),[2,new yt(f)]}}))}))}function St(t){return s(this,void 0,void 0,(function(){var r,i,o,a,s;return u(this,(function(u){switch(u.label){case 0:if(r=t.outputStride,i=t.quantBytes,null==e)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this\n        model.");return o=function(t,e){var n="model-stride"+t+".json";return 4===e?$+"float/"+n:$+"quant"+e+"/"+n}(r,i),[4,n.loadGraphModel(t.modelUrl||o)];case 1:return a=u.sent(),s=new Y(a,r),[2,new yt(s)]}}))}))}function xt(t){return void 0===t&&(t=dt),s(this,void 0,void 0,(function(){return u(this,(function(e){return"ResNet50"===(t=function(t){if(null==(t=t||dt).architecture&&(t.architecture="MobileNetV1"),lt.indexOf(t.architecture)<0)throw new Error("Invalid architecture "+t.architecture+". Should be one of "+lt);if(null==t.outputStride&&(t.outputStride=16),ct[t.architecture].indexOf(t.outputStride)<0)throw new Error("Invalid outputStride "+t.outputStride+". Should be one of "+ct[t.architecture]+" for architecture "+t.architecture+".");if(null==t.multiplier&&(t.multiplier=1),ht[t.architecture].indexOf(t.multiplier)<0)throw new Error("Invalid multiplier "+t.multiplier+". Should be one of "+ht[t.architecture]+" for architecture "+t.architecture+".");if(null==t.quantBytes&&(t.quantBytes=4),pt.indexOf(t.quantBytes)<0)throw new Error("Invalid quantBytes "+t.quantBytes+". Should be one of "+pt+" for architecture "+t.architecture+".");return t}(t)).architecture?[2,St(t)]:"MobileNetV1"===t.architecture?[2,bt(t)]:[2,null]}))}))}var Mt=["left_face","right_face","left_upper_arm_front","left_upper_arm_back","right_upper_arm_front","right_upper_arm_back","left_lower_arm_front","left_lower_arm_back","right_lower_arm_front","right_lower_arm_back","left_hand","right_hand","torso_front","torso_back","left_upper_leg_front","left_upper_leg_back","right_upper_leg_front","right_upper_leg_back","left_lower_leg_front","left_lower_leg_back","right_lower_leg_front","right_lower_leg_back","left_feet","right_feet"],kt=function(){function t(t){this.mask=t}return t.prototype.toCanvasImageSource=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,d(this.mask)]}))}))},t.prototype.toImageData=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,this.mask]}))}))},t.prototype.toTensor=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,c(this.mask)]}))}))},t.prototype.getUnderlyingType=function(){return"imagedata"},t}();function Tt(t){if(h(t),255!==t)throw new Error("Foreground id must be 255 but got "+t);return"person"}function Et(t){if(h(t),t>=Mt.length)throw new Error("Invalid body part value "+t);return Mt[t]}var Pt=function(){function t(t){this.bodyPixModel=t}return t.prototype.segmentPeople=function(t,e){return s(this,void 0,void 0,(function(){var n,r,i,o;return u(this,(function(a){switch(a.label){case 0:return t instanceof ImageBitmap&&((n=document.createElement("canvas")).getContext("2d").drawImage(t,0,0),t=n),e.segmentBodyParts?e.multiSegmentation?[4,this.bodyPixModel.segmentMultiPersonParts(t,e)]:[3,2]:[3,5];case 1:return i=a.sent(),[3,4];case 2:return[4,this.bodyPixModel.segmentPersonParts(t,e)];case 3:i=[a.sent()],a.label=4;case 4:return r=i.map((function(t){var e=t.data,n=t.width,r=t.height,i=new Uint8ClampedArray(n*r*4).fill(0);return e.forEach((function(t,e){-1===t?(i[4*e]=Mt.length,i[4*e+3]=0):(i[4*e]=t,i[4*e+3]=255)})),{maskValueToLabel:Et,mask:new kt(new ImageData(i,n,r))}})),[3,10];case 5:return e.multiSegmentation?[4,this.bodyPixModel.segmentMultiPerson(t,e)]:[3,7];case 6:return o=a.sent(),[3,9];case 7:return[4,this.bodyPixModel.segmentPerson(t,e)];case 8:o=[a.sent()],a.label=9;case 9:r=o.map((function(t){var e=t.data,n=t.width,r=t.height,i=new Uint8ClampedArray(n*r*4).fill(0);return e.forEach((function(t,e){0===t?(i[4*e]=0,i[4*e+3]=0):(i[4*e]=255,i[4*e+3]=255)})),{maskValueToLabel:Tt,mask:new kt(new ImageData(i,n,r))}})),a.label=10;case 10:return[2,r]}}))}))},t.prototype.dispose=function(){this.bodyPixModel.dispose()},t.prototype.reset=function(){},t}();function It(t){return s(this,void 0,void 0,(function(){return u(this,(function(e){return[2,xt(t).then((function(t){return new Pt(t)}))]}))}))}var Ot={runtime:"mediapipe",modelType:"general"};var _t=function(){function t(t){this.mask=t}return t.prototype.toCanvasImageSource=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,this.mask]}))}))},t.prototype.toImageData=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,l(this.mask)]}))}))},t.prototype.toTensor=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,c(this.mask)]}))}))},t.prototype.getUnderlyingType=function(){return"canvasimagesource"},t}();function Ht(t){return h(t),"person"}var At=function(){function t(t){var e,n=this;this.selfieMode=!1;var i;if(this.selfieSegmentationSolution=new r.SelfieSegmentation({locateFile:null!==(e=t.locateFile)&&void 0!==e?e:function(e,n){return t.solutionPath?t.solutionPath.replace(/\/+$/,"")+"/"+e:n+"/"+e}}),"landscape"===t.modelType)i=1;else i=0;this.selfieSegmentationSolution.setOptions({modelSelection:i,selfieMode:this.selfieMode}),this.selfieSegmentationSolution.onResults((function(t){n.segmentation=[{maskValueToLabel:Ht,mask:new _t(t.segmentationMask)}]}))}return t.prototype.segmentPeople=function(t,n){return s(this,void 0,void 0,(function(){var r,i;return u(this,(function(o){switch(o.label){case 0:return n&&n.flipHorizontal&&n.flipHorizontal!==this.selfieMode&&(this.selfieMode=n.flipHorizontal,this.selfieSegmentationSolution.setOptions({selfieMode:this.selfieMode})),t instanceof e.Tensor?(i=ImageData.bind,[4,e.browser.toPixels(t)]):[3,2];case 1:return r=new(i.apply(ImageData,[void 0,o.sent(),t.shape[1],t.shape[0]])),[3,3];case 2:r=t,o.label=3;case 3:return t=r,[4,this.selfieSegmentationSolution.send({image:t})];case 4:return o.sent(),[2,this.segmentation]}}))}))},t.prototype.dispose=function(){this.selfieSegmentationSolution.close()},t.prototype.reset=function(){this.selfieSegmentationSolution.reset(),this.segmentation=null,this.selfieMode=!1},t.prototype.initialize=function(){return this.selfieSegmentationSolution.initialize()},t}();function Rt(t){return s(this,void 0,void 0,(function(){var e,n;return u(this,(function(r){switch(r.label){case 0:return e=function(t){if(null==t)return a({},Ot);var e=a({},t);return e.runtime="mediapipe",null==e.modelType&&(e.modelType=Ot.modelType),e}(t),[4,(n=new At(e)).initialize()];case 1:return r.sent(),[2,n]}}))}))}function Dt(t,e,n,r){var i=t.width,o=t.height,a=r?-1:1,s=Math.cos(t.rotation),u=Math.sin(t.rotation),f=t.xCenter,d=t.yCenter,l=1/e,c=1/n,h=new Array(16);return h[0]=i*s*a*l,h[1]=-o*u*l,h[2]=0,h[3]=(-.5*i*s*a+.5*o*u+f)*l,h[4]=i*u*a*c,h[5]=o*s*c,h[6]=0,h[7]=(-.5*o*s-.5*i*u*a+d)*c,h[8]=0,h[9]=0,h[10]=i*l,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,function(t){if(16!==t.length)throw new Error("Array length must be 16 but got "+t.length);return[[t[0],t[1],t[2],t[3]],[t[4],t[5],t[6],t[7]],[t[8],t[9],t[10],t[11]],[t[12],t[13],t[14],t[15]]]}(h)}function Ft(t){return t instanceof e.Tensor?{height:t.shape[0],width:t.shape[1]}:{height:t.height,width:t.width}}function Ct(t,n){e.util.assert(0!==t.width,(function(){return n+" width cannot be 0."})),e.util.assert(0!==t.height,(function(){return n+" height cannot be 0."}))}function Bt(t,n){var r=function(t,e,n,r){var i=e-t,o=r-n;if(0===i)throw new Error("Original min and max are both "+t+", range cannot be 0.");var a=o/i;return{scale:a,offset:n-t*a}}(0,255,n[0],n[1]);return e.tidy((function(){return e.add(e.mul(t,r.scale),r.offset)}))}function zt(t,n,r){var i=n.outputTensorSize,o=n.keepAspectRatio,a=n.borderMode,s=n.outputTensorFloatRange,u=Ft(t),f=function(t,e){return e?{xCenter:e.xCenter*t.width,yCenter:e.yCenter*t.height,width:e.width*t.width,height:e.height*t.height,rotation:e.rotation}:{xCenter:.5*t.width,yCenter:.5*t.height,width:t.width,height:t.height,rotation:0}}(u,r),d=function(t,e,n){if(void 0===n&&(n=!1),!n)return{top:0,left:0,right:0,bottom:0};var r=e.height,i=e.width;Ct(e,"targetSize"),Ct(t,"roi");var o,a,s=r/i,u=t.height/t.width,f=0,d=0;return s>u?(o=t.width,a=t.width*s,d=(1-u/s)/2):(o=t.height/s,a=t.height,f=(1-s/u)/2),t.width=o,t.height=a,{top:d,left:f,right:f,bottom:d}}(f,i,o),l=Dt(f,u.width,u.height,!1),c=e.tidy((function(){var n,r=(n=t)instanceof e.Tensor?n:e.browser.fromPixels(n),o=e.tensor2d(function(t,e,n){return Ct(n,"inputResolution"),[1/n.width*t[0][0]*e.width,1/n.height*t[0][1]*e.width,t[0][3]*e.width,1/n.width*t[1][0]*e.height,1/n.height*t[1][1]*e.height,t[1][3]*e.height,0,0]}(l,u,i),[1,8]),f="zero"===a?"constant":"nearest",d=e.image.transform(e.expandDims(e.cast(r,"float32")),o,"bilinear",f,0,[i.height,i.width]);return null!=s?Bt(d,s):d}));return{imageTensor:c,padding:d,transformationMatrix:l}}var Lt="https://tfhub.dev/mediapipe/tfjs-model/selfie_segmentation/general/1",qt={runtime:"tfjs",modelType:"general",modelUrl:Lt},Wt={flipHorizontal:!1},jt={outputTensorSize:{width:256,height:256},keepAspectRatio:!1,borderMode:"zero",outputTensorFloatRange:[0,1]},Vt={outputTensorSize:{width:256,height:144},keepAspectRatio:!1,borderMode:"zero",outputTensorFloatRange:[0,1]},Kt={activation:"none"};var Ut=function(){function t(t){this.mask=t}return t.prototype.toCanvasImageSource=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,d(this.mask)]}))}))},t.prototype.toImageData=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,l(this.mask)]}))}))},t.prototype.toTensor=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,this.mask]}))}))},t.prototype.getUnderlyingType=function(){return"tensor"},t}();function Nt(t){return h(t),"person"}var Qt,Gt=function(){function t(t,e){this.modelType=t,this.model=e}return t.prototype.segmentPeople=function(t,n){return s(this,void 0,void 0,(function(){var r,i=this;return u(this,(function(o){return n=function(t){if(null==t)return a({},Wt);var e=a({},t);return null==e.flipHorizontal&&(e.flipHorizontal=Wt.flipHorizontal),e}(n),null==t?(this.reset(),[2,[]]):(r=e.tidy((function(){var n=zt(t,"general"===i.modelType?jt:Vt).imageTensor,r=e.slice(i.model.predict(n),[0,0,0,1],-1),o=Ft(t),a=function(t,n,r){return e.tidy((function(){var i=e.squeeze(t,[0]),o=i.shape[2];if(1===o){var a=i;switch(n.activation){case"none":break;case"sigmoid":a=e.sigmoid(a);break;case"softmax":throw new Error("Softmax activation requires two channels.");default:throw new Error("Activation not supported ("+n.activation+")")}var s=r?e.image.resizeBilinear(a,[r.height,r.width]):a;return e.squeeze(s,[2])}throw new Error("Unsupported number of tensor channels "+o)}))}(r,Kt,o),s=e.expandDims(a,2),u=e.pad(s,[[0,0],[0,0],[0,1]]);return e.mirrorPad(u,[[0,0],[0,0],[0,2]],"symmetric")})),[2,[{maskValueToLabel:Nt,mask:new Ut(r)}]])}))}))},t.prototype.dispose=function(){this.model.dispose()},t.prototype.reset=function(){},t}();function Xt(t){return s(this,void 0,void 0,(function(){var e,r,i;return u(this,(function(o){switch(o.label){case 0:return e=function(t){if(null==t)return a({},qt);var e=a({},t);if(e.runtime="tfjs",null==e.modelType&&(e.modelType=qt.modelType),"general"!==e.modelType&&"landscape"!==e.modelType)throw new Error("Model type must be one of general or landscape, but got "+e.modelType);null==e.modelUrl&&("general"===e.modelType?e.modelUrl=Lt:e.modelUrl="https://tfhub.dev/mediapipe/tfjs-model/selfie_segmentation/landscape/1");return e}(t),r="string"==typeof e.modelUrl&&e.modelUrl.indexOf("https://tfhub.dev")>-1,[4,n.loadGraphModel(e.modelUrl,{fromTFHub:r})];case 1:return i=o.sent(),[2,new Gt(e.modelType,i)]}}))}))}(Qt=t.SupportedModels||(t.SupportedModels={})).BodyPix="BodyPix",Qt.MediaPipeSelfieSegmentation="MediaPipeSelfieSegmentation";var Yt="blurred",$t="blurred-mask",Jt="mask",Zt="lowres-part-mask",te="draw-image",ee={};function ne(t,e,n,r){var i=t.width,o=t.height,a=e.width,s=e.height;if(i!==a||o!==s)throw new Error("error: dimensions must match. "+n+" has dimensions "+i+"x"+o+", "+r+" has dimensions "+a+"x"+s)}function re(t){if("undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas||"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement)return function(t){if("offsetHeight"in t&&0!==t.offsetHeight&&"offsetWidth"in t&&0!==t.offsetWidth)return[t.offsetHeight,t.offsetWidth];if(null!=t.height&&null!=t.width)return[t.height,t.width];throw new Error("HTMLImageElement must have height and width attributes set.")}(t);if("undefined"!=typeof ImageData&&t instanceof ImageData)return[t.height,t.width];if("undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement)return function(t){return t.hasAttribute("height")&&t.hasAttribute("width")?[t.height,t.width]:[t.videoHeight,t.videoWidth]}(t);if(t instanceof e.Tensor)return[t.shape[0],t.shape[1]];throw new Error("error: Unknown input type: "+t+".")}function ie(t){return ee[t]||(ee[t]=function(){if("undefined"!=typeof document)return document.createElement("canvas");if("undefined"!=typeof OffscreenCanvas)return new OffscreenCanvas(0,0);throw new Error("Cannot create a canvas in this context")}()),ee[t]}function oe(t,e){var n=ie(e);return function(t,e){e.width=t.width,e.height=t.height,e.getContext("2d").putImageData(t,0,0)}(t,n),n}function ae(t,n,r,i,o,a){return s(this,void 0,void 0,(function(){var s,f,d,l;return u(this,(function(u){switch(u.label){case 0:return n instanceof e.Tensor?[4,e.browser.toPixels(n)]:[3,2];case 1:s=u.sent(),f=re(n),d=f[0],l=f[1],n=new ImageData(s,l,d),u.label=2;case 2:return n instanceof ImageData&&(n=oe(n,te)),null==o||null==a?t.drawImage(n,r,i):t.drawImage(n,r,i,o,a),[2]}}))}))}function se(t,e){return s(this,void 0,void 0,(function(){var n,r,i;return u(this,(function(o){switch(o.label){case 0:return n=re(t),r=n[0],i=n[1],e.width=i,e.height=r,[4,ae(e.getContext("2d"),t,0,0,i,r)];case 1:return o.sent(),[2]}}))}))}function ue(t){var e=t.getContext("2d");e.scale(-1,1),e.translate(-t.width,0)}function fe(t,e,n){return s(this,void 0,void 0,(function(){return u(this,(function(r){switch(r.label){case 0:return t.globalCompositeOperation=n,[4,ae(t,e,0,0)];case 1:return r.sent(),[2]}}))}))}function de(t,e,n){return s(this,void 0,void 0,(function(){var r,i,o,a,s,f,d,l;return u(this,(function(u){switch(u.label){case 0:for(r=t.getContext("2d"),i=0,o=5,a=1/(2*Math.PI*o*o),s=n<3?1:2,d=-n;d<=n;d+=s)for(l=-n;l<=n;l+=s)f=a*Math.exp(-(l*l+d*d)/(2*o*o)),i+=f;d=-n,u.label=1;case 1:if(!(d<=n))return[3,6];l=-n,u.label=2;case 2:return l<=n?(r.globalAlpha=a*Math.exp(-(l*l+d*d)/(2*o*o))/i*n,[4,ae(r,e,l,d)]):[3,5];case 3:u.sent(),u.label=4;case 4:return l+=s,[3,2];case 5:return d+=s,[3,1];case 6:return r.globalAlpha=1,[2]}}))}))}function le(t,e,n){return s(this,void 0,void 0,(function(){var r,i,o,a;return u(this,(function(s){switch(s.label){case 0:return r=re(t),i=r[0],o=r[1],a=n.getContext("2d"),n.width=o,n.height=i,a.clearRect(0,0,o,i),a.save(),/^((?!chrome|android).)*safari/i.test(navigator.userAgent)?[4,de(n,t,e)]:[3,2];case 1:return s.sent(),[3,4];case 2:return a.filter="blur("+e+"px)",[4,ae(a,t,0,0,o,i)];case 3:s.sent(),s.label=4;case 4:return a.restore(),[2]}}))}))}function ce(t,e,n){return s(this,void 0,void 0,(function(){var r;return u(this,(function(i){switch(i.label){case 0:return r=ie(n),0!==e?[3,2]:[4,se(t,r)];case 1:return i.sent(),[3,4];case 2:return[4,le(t,e,r)];case 3:i.sent(),i.label=4;case 4:return[2,r]}}))}))}function he(t,e,n,r,i,o){void 0===o&&(o={r:0,g:255,b:255,a:255});for(var a=-i;a<=i;a++)for(var s=-i;s<=i;s++)if(0!==a&&0!==s){var u=(e+a)*r+(n+s);t[4*u+0]=o.r,t[4*u+1]=o.g,t[4*u+2]=o.b,t[4*u+3]=o.a}}function pe(t,e,n,r,i,o,a){void 0===a&&(a=1);for(var s=0,u=-a;u<=a;u++)for(var f=-a;f<=a;f++)if(0!==u&&0!==f){var d=(e+u)*r+(n+f);(!i[t[4*d]]||t[4*d+3]<o)&&(s+=1)}return s>0}function me(t,e,n,r,i,o){return void 0===e&&(e={r:0,g:0,b:0,a:0}),void 0===n&&(n={r:0,g:0,b:0,a:255}),void 0===r&&(r=!1),void 0===i&&(i=.5),void 0===o&&(o=Array.from(Array(256).keys())),s(this,void 0,void 0,(function(){var a,s,f,d,l,c,h,p,m,g,v,w,y,b;return u(this,(function(u){switch(u.label){case 0:return 0===(a=Array.isArray(t)?t:[t]).length?[2,null]:[4,Promise.all(a.map((function(t){return t.mask.toImageData()})))];case 1:for(s=u.sent(),f=s[0],d=f.width,l=f.height,c=new Uint8ClampedArray(d*l*4),h=Math.round(255*i),p=new Array(256).fill(!1),o.forEach((function(t){return p[t]=!0})),m=0;m<l;m++)for(g=0;g<d;g++)for(c[4*(v=m*d+g)+0]=n.r,c[4*v+1]=n.g,c[4*v+2]=n.b,c[4*v+3]=n.a,w=0,y=s;w<y.length;w++)b=y[w],p[b.data[4*v]]&&b.data[4*v+3]>=h&&(c[4*v]=e.r,c[4*v+1]=e.g,c[4*v+2]=e.b,c[4*v+3]=e.a,r&&m-1>=0&&m+1<l&&g-1>=0&&g+1<d&&pe(b.data,m,g,d,p,h)&&he(c,m,g,d,1));return[2,new ImageData(c,d,l)]}}))}))}function ge(t,e,n){return s(this,void 0,void 0,(function(){var r,i;return u(this,(function(o){switch(o.label){case 0:return[4,me(t,{r:0,g:0,b:0,a:255},{r:0,g:0,b:0,a:0},!1,e)];case 1:return r=o.sent(),i=oe(r,Jt),0===n?[2,i]:[2,ce(i,n,$t)]}}))}))}function ve(t,e,n,r){return s(this,void 0,void 0,(function(){var i,o;return u(this,(function(a){switch(a.label){case 0:return[4,me(t,{r:0,g:0,b:0,a:0},{r:0,g:0,b:0,a:255},!0,n,e)];case 1:return i=a.sent(),o=oe(i,Jt),0===r?[2,o]:[2,ce(o,r,$t)]}}))}))}t.blurBodyPart=function(t,e,n,r,i,o,a,f){return void 0===i&&(i=.5),void 0===o&&(o=3),void 0===a&&(a=3),void 0===f&&(f=!1),s(this,void 0,void 0,(function(){var s,d,l,c,h,p;return u(this,(function(u){switch(u.label){case 0:return[4,ce(e,o,Yt)];case 1:return s=u.sent(),t.width=s.width,t.height=s.height,d=t.getContext("2d"),Array.isArray(n)&&0===n.length?(d.drawImage(s,0,0),[2]):[4,ve(n,r,i,a)];case 2:return l=u.sent(),d.save(),f&&ue(t),c=re(e),h=c[0],p=c[1],[4,ae(d,e,0,0,p,h)];case 3:return u.sent(),[4,fe(d,l,"destination-in")];case 4:return u.sent(),[4,fe(d,s,"destination-over")];case 5:return u.sent(),d.restore(),[2]}}))}))},t.bodyPixMaskValueToRainbowColor=function(t){if(h(t),t<p.length){var e=p[t];return{r:e[0],g:e[1],b:e[2],a:255}}throw new Error("Mask value must be in range [0, "+p.length+")")},t.createSegmenter=function(e,n){return s(this,void 0,void 0,(function(){var r,i;return u(this,(function(o){switch(e){case t.SupportedModels.MediaPipeSelfieSegmentation:if(r=void 0,null!=(i=n)){if("tfjs"===i.runtime)return[2,Xt(i)];if("mediapipe"===i.runtime)return[2,Rt(i)];r=i.runtime}throw new Error("Expect modelConfig.runtime to be either 'tfjs' or 'mediapipe', but got "+r);case t.SupportedModels.BodyPix:return[2,It(i=n)];default:throw new Error(e+" is not a supported model name.")}}))}))},t.drawBokehEffect=function(t,e,n,r,i,o,a){return void 0===r&&(r=.5),void 0===i&&(i=3),void 0===o&&(o=3),void 0===a&&(a=!1),s(this,void 0,void 0,(function(){var s,f,d,l,c,h;return u(this,(function(u){switch(u.label){case 0:return[4,ce(e,i,Yt)];case 1:return s=u.sent(),t.width=s.width,t.height=s.height,f=t.getContext("2d"),Array.isArray(n)&&0===n.length?(f.drawImage(s,0,0),[2]):[4,ge(n,r,o)];case 2:return d=u.sent(),f.save(),a&&ue(t),l=re(e),c=l[0],h=l[1],[4,ae(f,e,0,0,h,c)];case 3:return u.sent(),[4,fe(f,d,"destination-in")];case 4:return u.sent(),[4,fe(f,s,"destination-over")];case 5:return u.sent(),f.restore(),[2]}}))}))},t.drawMask=function(t,e,n,r,i,o){return void 0===r&&(r=.7),void 0===i&&(i=0),void 0===o&&(o=!1),s(this,void 0,void 0,(function(){var a,s,f,d,l;return u(this,(function(u){switch(u.label){case 0:return a=re(e),s=a[0],f=a[1],t.width=f,t.height=s,(d=t.getContext("2d")).save(),o&&ue(t),[4,ae(d,e,0,0)];case 1:return u.sent(),d.globalAlpha=r,n?(ne({width:f,height:s},n,"image","mask"),[4,ce(oe(n,Jt),i,$t)]):[3,3];case 2:l=u.sent(),d.drawImage(l,0,0,f,s),u.label=3;case 3:return d.restore(),[2]}}))}))},t.drawPixelatedMask=function(t,e,n,r,i,o,a){return void 0===r&&(r=.7),void 0===i&&(i=0),void 0===o&&(o=!1),void 0===a&&(a=10),s(this,void 0,void 0,(function(){var s,f,d,l,c,h,p;return u(this,(function(u){switch(u.label){case 0:return s=re(e),f=s[0],ne({width:s[1],height:f},n,"image","mask"),[4,ce(oe(n,Jt),i,$t)];case 1:for(d=u.sent(),t.width=d.width,t.height=d.height,(l=t.getContext("2d")).save(),o&&ue(t),c=ie(Zt),h=c.getContext("2d"),c.width=d.width*(1/a),c.height=d.height*(1/a),h.drawImage(d,0,0,d.width,d.height,0,0,c.width,c.height),l.imageSmoothingEnabled=!1,l.drawImage(c,0,0,c.width,c.height,0,0,t.width,t.height),p=0;p<c.width;p++)l.beginPath(),l.strokeStyle="#ffffff",l.moveTo(a*p,0),l.lineTo(a*p,t.height),l.stroke();for(p=0;p<c.height;p++)l.beginPath(),l.strokeStyle="#ffffff",l.moveTo(0,a*p),l.lineTo(t.width,a*p),l.stroke();return l.globalAlpha=1-r,[4,ae(l,e,0,0,d.width,d.height)];case 2:return u.sent(),l.restore(),[2]}}))}))},t.toBinaryMask=me,t.toColoredMask=function(t,e,n,r){return void 0===n&&(n={r:0,g:0,b:0,a:255}),void 0===r&&(r=.5),s(this,void 0,void 0,(function(){var i,o,a,s,f,d,l,c,h,p,m,g,v,w;return u(this,(function(u){switch(u.label){case 0:return 0===(i=Array.isArray(t)?t:[t]).length?[2,null]:[4,Promise.all(i.map((function(t){return t.mask.toImageData()})))];case 1:for(o=u.sent(),a=o[0],s=a.width,f=a.height,d=new Uint8ClampedArray(s*f*4),l=Math.round(255*r),c=0;c<f*s;++c)for(d[(h=4*c)+0]=n.r,d[h+1]=n.g,d[h+2]=n.b,d[h+3]=n.a,p=0,m=o;p<m.length;p++)(g=m[p]).data[h+3]>=l&&(v=g.data[h],w=e(v),d[h+0]=w.r,d[h+1]=w.g,d[h+2]=w.b,d[h+3]=w.a);return[2,new ImageData(d,s,f)]}}))}))},Object.defineProperty(t,"__esModule",{value:!0})}));
